<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üöÄ Product Hunt + üí∞ AppSumo Crawler</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 40px 20px;
      color: #222;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 25px;
      font-size: 2.2rem;
    }
    .topics {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .topic-btn {
      background: #f0f0f0;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }
    .topic-btn:hover { background: #e0e0e0; }
    .topic-btn.selected { background: #667eea; color: white; }

    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 30px;
    }
    input, select, button {
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button[type="submit"] {
      background: #667eea;
      color: white;
      font-weight: 600;
      border: none;
      transition: background 0.3s;
    }
    button[type="submit"]:hover { background: #5568d3; }

    #loading {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }

    #progressBar {
      width: 100%;
      background: #eee;
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    #progressFill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg,#667eea,#764ba2);
      text-align:center;
      color:white;
      font-size:0.8rem;
      line-height:20px;
      transition: width 0.3s;
    }

    .result-card {
      background: #fafafa;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #eee;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .result-card a { color:#4b3ba6;text-decoration:none; }
    .result-card a:hover { text-decoration:underline; }
    .badges { margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; }
    .badge {
      background:#667eea;
      color:white;
      padding:4px 10px;
      border-radius:10px;
      font-size:0.8rem;
    }
  </style>
</head>
<body>
  <h1>üöÄ Product Hunt + üí∞ AppSumo Crawler</h1>

  <div class="container">
    <div class="topics" id="topics-container"></div>

    <form id="crawlForm">
      <label>Maximum Products to Scrape:</label>
      <input type="number" id="maxPages" value="30" min="1" max="100"/>

      <label>Sort By:</label>
      <select id="sortBy">
        <option value="">Default</option>
        <option value="latest">Latest</option>
        <option value="rating">Rating</option>
        <option value="popularity">Popularity</option>
      </select>

      <label>Crawl Mode:</label>
      <select id="crawlMode">
        <option value="fast">Fast Mode ‚Äì quicker, may miss some data</option>
        <option value="complete">Complete Mode ‚Äì slower, more accurate</option>
      </select>

      <button type="submit">Start Crawling</button>
    </form>

    <div id="loading">
      <div class="spinner"></div>
      <p id="progressText">Fetching results...</p>
      <p style="font-size:0.9rem;color:#777;">Estimated time: 20‚Äì40 seconds</p>
      <div id="progressBar"><div id="progressFill">0%</div></div>
    </div>

    <div id="results"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded",()=>{
      const topics=[
        "Artificial Intelligence","Developer Tools","Design Tools","Marketing",
        "Productivity","Finance","Education","Health & Fitness","Web3","Startups",
        "Customer Communication","Wearables","Operations","Marketing & Sales",
        "Build it Yourself","Media Tools","Development & IT","Customer Experience"
      ];
      const topicsContainer=document.getElementById("topics-container");
      const resultsContainer=document.getElementById("results");
      const loading=document.getElementById("loading");
      const progressText=document.getElementById("progressText");
      const progressFill=document.getElementById("progressFill");
      const form=document.getElementById("crawlForm");
      let selectedTopic=null,progressTimer=null,progressPercent=0;

      topics.forEach(t=>{
        const btn=document.createElement("button");
        btn.textContent=t;
        btn.className="topic-btn";
        btn.onclick=(e)=>{
          e.preventDefault();
          document.querySelectorAll(".topic-btn").forEach(b=>b.classList.remove("selected"));
          btn.classList.add("selected");
          selectedTopic=t;
        };
        topicsContainer.appendChild(btn);
      });

      function firstNonEmpty(...vals){
        for (const v of vals){
          if (v === 0) return 0;
          if (Array.isArray(v) && v.length) return v;
          if (typeof v === "string" && v.trim()) return v.trim();
          if (v && typeof v !== "string") return v;
        }
        return null;
      }

      function normalizePrice(p){
        if (!p) return null;
        if (typeof p === "string") return p;
        if (Array.isArray(p)) return p.join(", ");
        if (typeof p === "object"){
          const parts=[];
          for (const k of Object.keys(p)){
            parts.push(`${k}: ${p[k]}`);
          }
          return parts.join(", ");
        }
        return String(p);
      }

      function normalizeBadges(p){
        const fromTopics = p.topics;
        const fromCats   = p.categories;
        if (Array.isArray(fromTopics)) return fromTopics;
        if (Array.isArray(fromCats))   return fromCats;
        const s = firstNonEmpty(fromTopics, fromCats);
        if (typeof s === "string") return s.split(",").map(x=>x.trim()).filter(Boolean);
        return [];
        }

      form.addEventListener("submit",async(e)=>{
        e.preventDefault();
        if(!selectedTopic){alert("Please select a topic first!");return;}
        const maxPages=parseInt(document.getElementById("maxPages").value);
        const sortBy=document.getElementById("sortBy").value;
        const crawlMode=document.getElementById("crawlMode").value;

        resultsContainer.innerHTML="";
        loading.style.display="block";
        progressPercent=0;
        progressFill.style.width="0%";
        progressFill.textContent="0%";
        progressTimer=setInterval(()=>{
          progressPercent+=Math.random()*10;
          if(progressPercent>=95)progressPercent=95;
          progressFill.style.width=Math.floor(progressPercent)+"%";
          progressFill.textContent=Math.floor(progressPercent)+"%";
          progressText.textContent=`‚öôÔ∏è Fetching ${selectedTopic} results... ${Math.floor(progressPercent)}%`;
        },1500);

        try{
          const res=await fetch("/api/combined-crawl",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              categories:[selectedTopic.toLowerCase()],
              maxPages,sortBy,crawlMode
            })
          });
          const data=await res.json();
          clearInterval(progressTimer);
          progressFill.style.width="100%";
          progressFill.textContent="100%";
          loading.style.display="none";

          if(!data.success||!data.products?.length){
            resultsContainer.innerHTML=`<p>No results found for ${selectedTopic} üòï</p>`;
            return;
          }

          const cards=data.products.map(raw=>{
            const isPH = raw.source === "Product Hunt";
            const sourceIcon = isPH ? "üöÄ Product Hunt" : "üí∞ AppSumo";
            const sourceColor = "#667eea";

            // --- Normalize fields for identical layout ---
            const tagline = firstNonEmpty(raw.tagline, raw.summary);
            const description = firstNonEmpty(raw.description, raw.longDescription, raw.summary);
            const rating = firstNonEmpty(raw.rating, raw.reviewsRating, "N/A");
            const votes  = firstNonEmpty(raw.votes, raw.reviews, raw.reviewsCount, null);
            let launched = firstNonEmpty(raw.launchDate, raw.founded, raw.releaseDate, null);
            // Format launched (year or date)
            let launchedHTML = "";
            if (launched){
              try{
                if (String(launched).length === 4 && /^[0-9]{4}$/.test(String(launched))){
                  launchedHTML = `<p><strong>Launched:</strong> ${launched}</p>`;
                } else {
                  const d = new Date(launched);
                  launchedHTML = isNaN(d) ? "" : `<p><strong>Launched:</strong> ${d.toLocaleDateString()}</p>`;
                }
              } catch(_) {}
            }

            // Pricing (AppSumo)
            const pricingText = normalizePrice(firstNonEmpty(raw.price, raw.lifetimePrice, raw.pricingTiers));
            const pricingHTML = pricingText ? `<p><strong>Pricing:</strong> ${pricingText}</p>` : "";

            // One link only (homepage fallback to url/producthunt_url)
            const homepage = firstNonEmpty(raw.homepage, raw.url, raw.producthunt_url);
            const homepageHTML = homepage ? `<p><a href="${homepage}" target="_blank">Visit Homepage</a></p>` : "";

            // Badges
            const badgeItems = normalizeBadges(raw);
            const badgesHTML = badgeItems.length
              ? `<div class="badges">${badgeItems.map(cat=>`<span class="badge">${cat}</span>`).join("")}</div>`
              : "";

            return `
              <div class="result-card">
                <h3 style="color:#4b3ba6;">${raw.name || "Untitled Product"}</h3>
                <p style="font-weight:600;color:${sourceColor};">${sourceIcon}</p>

                ${tagline ? `<p><strong>Tagline:</strong> ${tagline}</p>` : `<p><strong>Tagline:</strong> N/A</p>`}
                ${description ? `<p><strong>Description:</strong> ${description}</p>` : ``}
                ${!isPH ? pricingHTML : ``}
                <p><strong>Rating:</strong> ${rating}</p>
                ${votes !== null ? `<p><strong>Votes:</strong> ${votes}</p>` : ``}
                ${launchedHTML}
                ${homepageHTML}
                ${badgesHTML}
              </div>
            `;
          }).join("");

          resultsContainer.innerHTML=`
            <h2 style="margin-top:10px;">Results for ${selectedTopic}</h2>
            <p style="color:#555;font-size:0.9rem;">Total combined results: ${data.products.length}</p>
            ${cards}`;
        }catch(err){
          clearInterval(progressTimer);
          loading.style.display="none";
          resultsContainer.innerHTML=`<p>‚ö†Ô∏è Error fetching results. Please try again.</p>`;
        }
      });
    });
  </script>
</body>
</html>


